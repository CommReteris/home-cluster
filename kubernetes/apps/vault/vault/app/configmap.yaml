apiVersion: v1
data:
  app-policy.hcl: |
    path "auth/token/lookup-self" {
        capabilities = ["read"]
    }
    path "sys/internal/ui/mounts/auth/token/lookup-self" {
        capabilities = ["read"]
    }
    path "secret/*" {
        capabilities = ["create", "update", "read", "delete"]
    }
    path "caddycerts/*" {
        capabilities = ["create", "update", "read", "delete"]
    }
  bootstrap.sh: |
    #!/bin/sh

    OUTPUT=/tmp/output.txt
    export VAULT_TOKEN=$(cat /root/.vault-token)
    export VAULT_ADDR=http://vault.vault.svc:8200

    vault operator init -n 1 -t 1 >> ${OUTPUT?}

    unseal=$(cat ${OUTPUT?} | grep "Unseal Key 1:" | sed -e "s/Unseal Key 1: //g")
    root=$(cat ${OUTPUT?} | grep "Initial Root Token:" | sed -e "s/Initial Root Token: //g")

    vault operator unseal ${unseal?}

    vault login -no-print ${root?}

    vault secrets enable -version=2 -path=secret kv
    vault secrets enable -version=2 -path=caddycerts kv

    vault auth enable kubernetes

    vault write auth/kubernetes/config \
        kubernetes_host=https://kubernetes.default.svc \
        kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

    vault policy write app /vault/userconfig/cells-vault/app-policy.hcl

    vault write auth/kubernetes/role/app \
       bound_service_account_names=app \
       bound_service_account_namespaces=cells \
       policies=app \
       ttl=24h

    vault token create -policy=app
kind: ConfigMap
metadata:
  name: cells-vault
  namespace: vault
